<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pianificazione Viaggio</title>

  <!-- Leaflet (mappa open-source) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
          integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

  <style>
    :root{
      --text:#111; --muted:#666; --line:#e9e9e9; --shadow:0 8px 30px rgba(0,0,0,.06);
      --radius:16px;
    }
    body{ font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial; margin:0; color:var(--text); background:#fff; }
    .wrap{ max-width:1100px; margin:0 auto; padding:22px; }
    h1{ margin:0 0 8px; font-size:26px; letter-spacing:-.02em; }
    .meta{ color:var(--muted); font-size:13px; }

    .controls{ display:flex; flex-wrap:wrap; gap:10px; align-items:center; margin:14px 0; }
    input[type="text"], select{
      padding:10px 12px; border:1px solid var(--line); border-radius:12px; background:#fff; font-size:14px;
    }

    .kpis{ display:flex; flex-wrap:wrap; gap:10px; margin:12px 0 18px; }
    .kpi{ border:1px solid var(--line); border-radius:14px; padding:10px 12px; box-shadow:var(--shadow); background:#fff; }
    .kpi .v{ font-size:18px; font-weight:800; }
    .kpi .l{ font-size:12px; color:var(--muted); margin-top:2px; }

    .tabs{ display:flex; gap:8px; margin:14px 0 12px; }
    .tab{ padding:10px 12px; border:1px solid var(--line); border-radius:999px; background:#fff; cursor:pointer; font-size:14px; }
    .tab.active{ background:#111; color:#fff; border-color:#111; }

    .grid{ display:grid; grid-template-columns: 1.15fr .85fr; gap:14px; }
    @media (max-width: 920px){ .grid{ grid-template-columns:1fr; } }

    .panel{ border:1px solid var(--line); border-radius:var(--radius); box-shadow:var(--shadow); overflow:hidden; background:#fff; }
    .panel .hd{ padding:14px; border-bottom:1px solid var(--line); display:flex; justify-content:space-between; gap:10px; align-items:center; }
    .panel .hd h2{ margin:0; font-size:16px; }
    .panel .bd{ padding:14px; }

    .day{ border:1px solid var(--line); border-radius:16px; overflow:hidden; margin:12px 0; }
    .dayTop{ padding:12px 14px; background:#fafafa; border-bottom:1px solid var(--line); display:flex; justify-content:space-between; gap:10px; align-items:center; }
    .dayTop .d{ font-weight:800; }
    .dayTop .s{ color:var(--muted); font-size:13px; }

    .lanes{ display:grid; grid-template-columns: 1fr 1fr; }
    @media (max-width: 920px){ .lanes{ grid-template-columns:1fr; } }
    .lane{ padding:12px 14px; }
    .lane.trip{ background:#f7fff2; }
    .lane.night{ background:#f6f6ff; border-left:1px solid var(--line); }
    @media (max-width: 920px){ .lane.night{ border-left:none; border-top:1px solid var(--line);} }

    .laneTitle{ display:flex; gap:8px; align-items:center; margin-bottom:10px; }
    .pill{ font-size:12px; padding:4px 8px; border-radius:999px; border:1px solid var(--line); background:#fff; }
    .card{ border:1px solid var(--line); background:#fff; border-radius:14px; padding:10px 12px; margin:10px 0; }
    .route{ font-weight:900; letter-spacing:-.01em; }
    .place{ font-weight:900; }
    .sub{ margin-top:4px; color:var(--muted); font-size:13px; display:flex; flex-wrap:wrap; gap:10px; }
    .flag{ font-size:12px; padding:3px 8px; border-radius:999px; border:1px solid var(--line); background:#fff; }
    .link{ color:inherit; text-decoration:none; border-bottom:1px dashed #bbb; }
    .warn{ border-color:#f0d7a7; background:#fffaf0; }
    .ok{ border-color:#d4edd4; background:#f6fff6; }

    #map{ height:540px; width:100%; border-radius:16px; }
    .hidden{ display:none !important; }

    table{ width:100%; border-collapse:collapse; font-size:14px; }
    th, td{ border-bottom:1px solid var(--line); padding:10px 8px; text-align:left; vertical-align:top; }
    th{ font-size:12px; color:var(--muted); font-weight:800; text-transform:uppercase; letter-spacing:.04em; }
    .rowMini{ color:var(--muted); font-size:12px; margin-top:2px; }
  </style>
</head>

<body>
  <div class="wrap">
    <h1>Pianificazione viaggio</h1>
    <div class="meta" id="sourceMeta">Fonte: viaggio2.csv (stessa cartella del sito)</div>

    <div class="controls">
      <input id="q" type="text" placeholder="Cerca (citt√†, hotel, note...)" style="min-width:260px;"/>
      <select id="type">
        <option value="">Tutte</option>
        <option value="Trip">Trip</option>
        <option value="Notte">Notte</option>
      </select>
      <select id="city"><option value="">Tutte le citt√†</option></select>
      <select id="status"><option value="">Tutti gli stati</option></select>
    </div>

    <div class="kpis">
      <div class="kpi"><div class="v" id="kDays">‚Äî</div><div class="l">giorni</div></div>
      <div class="kpi"><div class="v" id="kTrips">‚Äî</div><div class="l">tratte (Trip)</div></div>
      <div class="kpi"><div class="v" id="kNights">‚Äî</div><div class="l">notti</div></div>
      <div class="kpi"><div class="v" id="kKm">‚Äî</div><div class="l">km totali</div></div>
      <div class="kpi"><div class="v" id="kCost">‚Äî</div><div class="l">costo totale</div></div>
    </div>

    <div class="tabs">
      <div class="tab active" data-tab="timeline">Timeline</div>
      <div class="tab" data-tab="map">Mappa</div>
      <div class="tab" data-tab="bookings">Prenotazioni</div>
    </div>

    <div id="view-timeline">
      <div class="grid">
        <div class="panel">
          <div class="hd">
            <h2>Giorno per giorno</h2>
            <div class="meta" id="metaCount">‚Äî</div>
          </div>
          <div class="bd" id="timeline"></div>
        </div>

        <div class="panel">
          <div class="hd">
            <h2>Riepilogo citt√†</h2>
            <div class="meta">notti + tratte</div>
          </div>
          <div class="bd" id="citySummary"></div>
        </div>
      </div>
    </div>

    <div id="view-map" class="hidden">
      <div class="panel">
        <div class="hd">
          <h2>Mappa (OpenStreetMap)</h2>
          <div class="meta" id="mapMeta">‚Äî</div>
        </div>
        <div class="bd">
          <div id="map"></div>
          <div class="meta" style="margin-top:10px;">
            Compila ‚ÄúLat / Long‚Äù nel CSV in formato <code>lat, long</code> (es. <code>41.3874, 2.1686</code>).
          </div>
        </div>
      </div>
    </div>

    <div id="view-bookings" class="hidden">
      <div class="panel">
        <div class="hd">
          <h2>Prenotazioni (solo Notti)</h2>
          <div class="meta">hotel ¬∑ link ¬∑ stato ¬∑ costo</div>
        </div>
        <div class="bd" id="bookings"></div>
      </div>
    </div>
  </div>

<script>
  // ========= CONFIG =========
  const CSV_PATH = "./viaggio2.csv"; // stesso folder di index.html

  const COLS = [
    "Inc","N. days","Data","Attivit√†","Partenza","Arrivo","Luogo","Km",
    "Pernottamento","Stato","Costo","Note","Lat / Long","Link"
  ];

  let rows = [];
  let map, mapLayerGroup, mapReady = false;

  // ========= CSV parser (robusto per virgolette) =========
  function parseCSV(text){
    const rows = [];
    let row = [], cell = "", inQuotes = false;

    for(let i=0;i<text.length;i++){
      const c = text[i];
      const n = text[i+1];

      if(c === '"'){
        if(inQuotes && n === '"'){ cell += '"'; i++; }
        else inQuotes = !inQuotes;
      } else if(!inQuotes && (c === ',' || c === '\n' || c === '\r')){
        if(c === ','){ row.push(cell); cell = ""; }
        else{
          row.push(cell);
          // ignora righe vuote
          if(row.some(x => String(x).trim() !== "")) rows.push(row);
          row = []; cell = "";
          if(c === '\r' && n === '\n') i++;
        }
      } else {
        cell += c;
      }
    }
    if(cell.length || row.length){
      row.push(cell);
      if(row.some(x => String(x).trim() !== "")) rows.push(row);
    }
    return rows;
  }

  const norm = (s) => String(s ?? "").trim();
  const low = (s) => norm(s).toLowerCase();

  function toISO(ddmmyyyy){
    const v = norm(ddmmyyyy);
    const m = v.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
    if(!m) return "";
    return `${m[3]}-${m[2].padStart(2,"0")}-${m[1].padStart(2,"0")}`;
  }
  function fmtIT(iso){
    const d = new Date(iso+"T00:00:00");
    return d.toLocaleDateString("it-IT",{weekday:"short", day:"2-digit", month:"2-digit", year:"numeric"});
  }
  function safeNum(v){
    const s = norm(v).replace(/[^\d,.\-]/g,"").replace(",",".");
    const n = Number(s);
    return Number.isFinite(n) ? n : 0;
  }
  function parseLatLng(s){
    const v = norm(s);
    if(!v) return null;
    const parts = v.split(/[,\s;]+/).filter(Boolean);
    if(parts.length < 2) return null;
    const lat = Number(parts[0]);
    const lng = Number(parts[1]);
    if(Number.isFinite(lat) && Number.isFinite(lng)) return {lat, lng};
    return null;
  }

  // ========= LOAD =========
  async function load(){
    const res = await fetch(CSV_PATH, {cache:"no-store"});
    if(!res.ok){
      throw new Error(`Impossibile caricare ${CSV_PATH}. Controlla che sia nella stessa cartella e che GitHub Pages lo serva.`);
    }
    const text = await res.text();
    const matrix = parseCSV(text);

    const header = matrix[0].map(h => norm(h));
    // mappa posizione colonne
    const idx = new Map();
    header.forEach((h,i)=>idx.set(h,i));

    // se il CSV usa ';' come separatore, qui non lo rileviamo: in quel caso esporta con virgole.
    // (se ti serve, posso aggiungere autodetect.)

    rows = matrix.slice(1).map(r=>{
      const obj = {};
      // riempi solo le colonne attese (se mancanti, vuoto)
      for(const c of COLS){
        const i = idx.get(c);
        obj[c] = i === undefined ? "" : norm(r[i]);
      }
      obj._dateISO = toISO(obj["Data"]);
      obj._act = obj["Attivit√†"];
      obj._city = obj["Luogo"] || obj["Arrivo"] || obj["Partenza"] || "";
      obj._km = safeNum(obj["Km"]);
      obj._cost = safeNum(obj["Costo"]);
      obj._latlng = parseLatLng(obj["Lat / Long"]);
      return obj;
    }).filter(r=>r._dateISO);

    rows.sort((a,b)=> a._dateISO.localeCompare(b._dateISO) || (norm(a._act)==="Trip" ? -1 : 1));

    rebuildFilters();
    renderAll();
  }

  // ========= FILTERS =========
  function getFilters(){
    return {
      q: low(document.getElementById("q").value),
      type: norm(document.getElementById("type").value),
      city: norm(document.getElementById("city").value),
      status: norm(document.getElementById("status").value),
    };
  }
  function applyFilters(data){
    const f = getFilters();
    return data.filter(r=>{
      if(f.type && norm(r["Attivit√†"]) !== f.type) return false;
      if(f.city && norm(r._city) !== f.city) return false;
      if(f.status && norm(r["Stato"]) !== f.status) return false;
      if(f.q){
        const blob = Object.values(r).join(" ").toLowerCase();
        if(!blob.includes(f.q)) return false;
      }
      return true;
    });
  }
  function rebuildFilters(){
    const citySet = new Set();
    const statusSet = new Set();
    rows.forEach(r=>{
      const c = norm(r._city); if(c) citySet.add(c);
      const st = norm(r["Stato"]); if(st) statusSet.add(st);
    });

    const citySel = document.getElementById("city");
    citySel.length = 1;
    [...citySet].sort((a,b)=>a.localeCompare(b,"it")).forEach(c=>{
      const o=document.createElement("option"); o.value=c; o.textContent=c; citySel.appendChild(o);
    });

    const statusSel = document.getElementById("status");
    statusSel.length = 1;
    [...statusSet].sort((a,b)=>a.localeCompare(b,"it")).forEach(s=>{
      const o=document.createElement("option"); o.value=s; o.textContent=s; statusSel.appendChild(o);
    });
  }

  // ========= RENDER =========
  function renderAll(){
    const filtered = applyFilters(rows);

    const days = new Set(filtered.map(r=>r._dateISO)).size;
    const trips = filtered.filter(r=>norm(r["Attivit√†"])==="Trip").length;
    const nights = filtered.filter(r=>norm(r["Attivit√†"])==="Notte").length;
    const km = filtered.reduce((s,r)=>s+(r._km||0),0);
    const cost = filtered.reduce((s,r)=>s+(r._cost||0),0);

    document.getElementById("kDays").textContent = days || "‚Äî";
    document.getElementById("kTrips").textContent = trips || "‚Äî";
    document.getElementById("kNights").textContent = nights || "‚Äî";
    document.getElementById("kKm").textContent = km ? km.toLocaleString("it-IT") : "‚Äî";
    document.getElementById("kCost").textContent = cost ? cost.toLocaleString("it-IT") : "‚Äî";

    document.getElementById("metaCount").textContent = filtered.length ? `${filtered.length} righe` : "nessun risultato";

    renderTimeline(filtered);
    renderCitySummary(filtered);
    renderBookings(filtered);
    renderMap(filtered);
  }

  function renderTimeline(data){
    const out = document.getElementById("timeline");
    out.innerHTML = "";

    const by = new Map();
    for(const r of data){
      if(!by.has(r._dateISO)) by.set(r._dateISO, []);
      by.get(r._dateISO).push(r);
    }
    const days = [...by.keys()].sort();

    for(const d of days){
      const items = by.get(d);
      const tripItems = items.filter(r=>norm(r["Attivit√†"])==="Trip");
      const nightItems = items.filter(r=>norm(r["Attivit√†"])==="Notte");

      const dayKm = tripItems.reduce((s,r)=>s+(r._km||0),0);
      const dayCost = items.reduce((s,r)=>s+(r._cost||0),0);

      const dayBox = document.createElement("div");
      dayBox.className = "day";
      dayBox.innerHTML = `
        <div class="dayTop">
          <div class="d">${fmtIT(d)}</div>
          <div class="s">${dayKm ? (dayKm.toLocaleString("it-IT")+" km") : ""}${dayKm && dayCost ? " ¬∑ " : ""}${dayCost ? dayCost.toLocaleString("it-IT") : ""}</div>
        </div>
        <div class="lanes">
          <div class="lane trip">
            <div class="laneTitle"><span class="pill">TRIP</span><strong>Spostamenti</strong></div>
            <div class="laneBody" data-lane="trip"></div>
          </div>
          <div class="lane night">
            <div class="laneTitle"><span class="pill">NOTTE</span><strong>Pernotti</strong></div>
            <div class="laneBody" data-lane="night"></div>
          </div>
        </div>
      `;

      const tripLane = dayBox.querySelector('[data-lane="trip"]');
      const nightLane = dayBox.querySelector('[data-lane="night"]');

      if(!tripItems.length){
        tripLane.innerHTML = `<div class="meta">Nessuno spostamento</div>`;
      } else {
        for(const r of tripItems){
          const km = r._km;
          const warn = (km >= 500) ? "warn" : "";
          const st = norm(r["Stato"]);
          const cost = r._cost ? r._cost.toLocaleString("it-IT") : "";
          const notes = norm(r["Note"]);
          const link = norm(r["Link"]);
          const linkHtml = (link && link !== "?") ? ` ¬∑ <a class="link" href="${link}" target="_blank" rel="noopener">link</a>` : "";

          const route = `${norm(r["Partenza"]) || "‚Äî"} ‚Üí ${norm(r["Arrivo"]) || "‚Äî"}`;

          const card = document.createElement("div");
          card.className = `card ${warn}`;
          card.innerHTML = `
            <div class="route">üöó ${route}</div>
            <div class="sub">
              ${km ? `<span class="flag">${km.toLocaleString("it-IT")} km</span>` : ""}
              ${st ? `<span class="flag">${st}</span>` : ""}
              ${cost ? `<span class="flag">${cost}</span>` : ""}
              ${notes ? `<span>üìù ${notes}</span>` : ""}
              ${linkHtml ? `<span>${linkHtml}</span>` : ""}
            </div>
          `;
          tripLane.appendChild(card);
        }
      }

      if(!nightItems.length){
        nightLane.innerHTML = `<div class="meta">Nessun pernotto</div>`;
      } else {
        for(const r of nightItems){
          const place = norm(r["Luogo"]) || norm(r["Arrivo"]) || norm(r["Partenza"]) || "‚Äî";
          const hotel = norm(r["Pernottamento"]);
          const st = norm(r["Stato"]);
          const cost = r._cost ? r._cost.toLocaleString("it-IT") : "";
          const notes = norm(r["Note"]);
          const link = norm(r["Link"]);
          const ok = st && ["prenotato","pagato","confermato"].includes(low(st)) ? "ok" : "";
          const linkHtml = (link && link !== "?") ? `<a class="link" href="${link}" target="_blank" rel="noopener">link</a>` : "";

          const card = document.createElement("div");
          card.className = `card ${ok}`;
          card.innerHTML = `
            <div class="place">üõèÔ∏è ${place}</div>
            <div class="sub">
              ${hotel ? `<span>üè® ${hotel}</span>` : `<span class="meta">Hotel: ‚Äî</span>`}
              ${st ? `<span class="flag">${st}</span>` : ""}
              ${cost ? `<span class="flag">${cost}</span>` : ""}
              ${linkHtml ? `<span>üîó ${linkHtml}</span>` : ""}
              ${notes ? `<span>üìù ${notes}</span>` : ""}
            </div>
          `;
          nightLane.appendChild(card);
        }
      }

      out.appendChild(dayBox);
    }

    if(!days.length){
      out.innerHTML = `<div class="meta">Nessun dato da mostrare con questi filtri.</div>`;
    }
  }

  function renderCitySummary(data){
    const out = document.getElementById("citySummary");
    const m = new Map();

    for(const r of data){
      const c = norm(r._city);
      if(!c) continue;
      if(!m.has(c)) m.set(c, {nights:0, tripsOut:0, tripsIn:0, km:0, cost:0});
      const s = m.get(c);
      const act = norm(r["Attivit√†"]);
      if(act === "Notte") s.nights++;
      if(act === "Trip"){
        s.km += (r._km||0);
        const from = norm(r["Partenza"]);
        const to = norm(r["Arrivo"]);
        if(from === c) s.tripsOut++;
        if(to === c) s.tripsIn++;
      }
      s.cost += (r._cost||0);
    }

    const items = [...m.entries()].sort((a,b)=> (b[1].nights - a[1].nights) || a[0].localeCompare(b[0],"it"));
    if(!items.length){
      out.innerHTML = `<div class="meta">Nessuna citt√† (controlla Luogo/Arrivo/Partenza).</div>`;
      return;
    }

    out.innerHTML = items.map(([city, s]) => `
      <div class="card">
        <div style="display:flex; justify-content:space-between; gap:10px; align-items:baseline;">
          <div style="font-weight:900;">${city}</div>
          <div class="meta">${s.nights} notti</div>
        </div>
        <div class="sub">
          <span class="flag">Trip out: ${s.tripsOut}</span>
          <span class="flag">Trip in: ${s.tripsIn}</span>
          <span class="flag">${s.km ? s.km.toLocaleString("it-IT")+" km" : "‚Äî"}</span>
          <span class="flag">${s.cost ? s.cost.toLocaleString("it-IT") : "‚Äî"}</span>
        </div>
      </div>
    `).join("");
  }

  function renderBookings(data){
    const out = document.getElementById("bookings");
    const nights = data.filter(r=>norm(r["Attivit√†"])==="Notte");
    if(!nights.length){
      out.innerHTML = `<div class="meta">Nessuna notte con questi filtri.</div>`;
      return;
    }

    const byCity = new Map();
    nights.forEach(r=>{
      const c = norm(r._city) || "‚Äî";
      if(!byCity.has(c)) byCity.set(c, []);
      byCity.get(c).push(r);
    });

    let html = "";
    for(const [city, items] of [...byCity.entries()].sort((a,b)=>a[0].localeCompare(b[0],"it"))){
      html += `<h3 style="margin:10px 0 6px; font-size:16px;">${city} <span class="meta">(${items.length} notti)</span></h3>`;
      html += `<table>
        <thead><tr>
          <th>Data</th><th>Hotel</th><th>Stato</th><th>Costo</th><th>Link / Note</th>
        </tr></thead><tbody>`;

      for(const r of items.sort((a,b)=>a._dateISO.localeCompare(b._dateISO))){
        const link = norm(r["Link"]);
        const linkHtml = (link && link !== "?") ? `<a class="link" href="${link}" target="_blank" rel="noopener">apri</a>` : "‚Äî";
        html += `<tr>
          <td>${fmtIT(r._dateISO)}</td>
          <td>${norm(r["Pernottamento"]) || "‚Äî"}</td>
          <td>${norm(r["Stato"]) || "‚Äî"}</td>
          <td>${r._cost ? r._cost.toLocaleString("it-IT") : "‚Äî"}</td>
          <td>
            ${linkHtml}
            ${norm(r["Note"]) ? `<div class="rowMini">üìù ${norm(r["Note"])}</div>` : ""}
          </td>
        </tr>`;
      }
      html += `</tbody></table>`;
    }
    out.innerHTML = html;
  }

  // ========= MAP =========
  function initMap(){
    if(mapReady) return;
    mapReady = true;
    map = L.map('map', { scrollWheelZoom:true }).setView([41.9, 12.5], 5);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom:19,
      attribution:'&copy; OpenStreetMap'
    }).addTo(map);
    mapLayerGroup = L.layerGroup().addTo(map);
  }

  function renderMap(data){
    const mapVisible = !document.getElementById("view-map").classList.contains("hidden");
    if(!mapVisible && !mapReady) return;

    initMap();
    mapLayerGroup.clearLayers();

    const cityToLatLng = new Map();
    for(const r of data){
      const c = norm(r._city);
      if(!c) continue;
      if(!cityToLatLng.has(c) && r._latlng) cityToLatLng.set(c, r._latlng);
    }

    const markers = [];
    for(const [city, ll] of cityToLatLng.entries()){
      const mk = L.marker([ll.lat, ll.lng])
        .bindPopup(`<strong>${city}</strong><br/>${ll.lat}, ${ll.lng}`);
      mk.addTo(mapLayerGroup);
      markers.push(mk);
    }

    const tripRows = data.filter(r=>norm(r["Attivit√†"])==="Trip");
    const lines = [];
    for(const r of tripRows){
      const from = norm(r["Partenza"]);
      const to = norm(r["Arrivo"]);
      const a = cityToLatLng.get(from);
      const b = cityToLatLng.get(to);
      if(a && b){
        const line = L.polyline([[a.lat,a.lng],[b.lat,b.lng]]);
        line.bindPopup(`<strong>${from} ‚Üí ${to}</strong>${r._km ? `<br/>${r._km.toLocaleString("it-IT")} km` : ""}`);
        line.addTo(mapLayerGroup);
        lines.push(line);
      }
    }

    const allLayers = [...markers, ...lines];
    if(allLayers.length){
      const group = L.featureGroup(allLayers);
      map.fitBounds(group.getBounds().pad(0.15));
      document.getElementById("mapMeta").textContent = `${markers.length} tappe ¬∑ ${lines.length} tratte (con coordinate)`;
    } else {
      document.getElementById("mapMeta").textContent = "Nessuna coordinata trovata. Compila la colonna ‚ÄúLat / Long‚Äù.";
      map.setView([41.9, 12.5], 5);
    }
  }

  // ========= TABS =========
  function setTab(name){
    document.querySelectorAll(".tab").forEach(t=> t.classList.toggle("active", t.dataset.tab===name));
    document.getElementById("view-timeline").classList.toggle("hidden", name!=="timeline");
    document.getElementById("view-map").classList.toggle("hidden", name!=="map");
    document.getElementById("view-bookings").classList.toggle("hidden", name!=="bookings");
    if(name==="map") renderMap(applyFilters(rows));
  }
  document.querySelectorAll(".tab").forEach(t=> t.addEventListener("click", ()=>setTab(t.dataset.tab)));

  // filters events
  ["q","type","city","status"].forEach(id=>{
    const el = document.getElementById(id);
    el.addEventListener("input", renderAll);
    el.addEventListener("change", renderAll);
  });

  // start
  load().catch(err=>{
    document.getElementById("sourceMeta").textContent = "Errore: " + err.message;
    console.error(err);
  });
</script>
</body>
</html>
